<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous"></script>
</head>
<style>

.label-background {
  fill: white;
  fill-opacity: .5;
}

.axis {
  font-family: Helvetica, sans-serif;
  font-size: 14px;
}

.book-title {
  font-weight: bold;
}

body {
  font-family: Helvetica;
}

</style>

<body>
<h3>Asian American Literature</h3>
<form >
  <input type='radio' name='reviews' value='author' checked> By Author <br>
  <input type='radio' name='reviews' value='date'> By Date <br><br>
</form>
<svg width="1000" height="500" id="container"></svg>
<script>

//TODO: remove duplicates

var svg = d3.select('#container'),
    w = +svg.attr("width"),
    h = +svg.attr("height");

var margin = {top: 50, right: 200, bottom: 150, left: 100};
var xAxisSpace = 60,
    xAxisPadding = 20,
    circleRadius = 12,
    width = w - margin.right,
    height = h - margin.bottom;

var focus = svg.append('g')
               .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

// set the ranges for the scales. xScale will be dynamically done
var xScale,
    yScale = d3.scaleLinear().range([height - xAxisSpace, 0]),
    colorScale = d3.scaleLinear().range([0,1]);

// listen for radio button change
d3.selectAll("input[name=reviews]").on("change", updateOnChange)

var parseTime = d3.timeParse("%Y-%m-%d")

function updateOnChange() {
  graphType = this.value;
  bindXScale(graphType);
  drawDataPoints(graphType);
}

function bindXScale(type) {
  if (type == 'author') {
    xScale = d3.scaleBand().rangeRound([0, width]).padding(0.1);
    xScale.domain(all_data.map(function(d) { return d.name; }))
  } else {
    xScale = d3.scaleTime().range([0,width]);
    xScale.domain(findPublicationExtent(all_data));
  }

  updateXAxis();
}

function findPublicationExtent(data) {
  var dates = [];
  data.forEach(function(datum) {
    var miniExtent = d3.extent(datum.nyt, function(d) { return parseTime(d.publication_dt)});
    dates = dates.concat(miniExtent);
  })
  return d3.extent(dates, function(d) { return d; });
}

var all_data;
var graphType;
var flattenedData;
d3.json('author_data.json', function(data) {
  all_data = data;
  flattenedData = flattenData(data);
  graphType = d3.select('input[name="reviews"]:checked').node().value;
  // set the domain
  yScale.domain([0, d3.max(data.map(function(d) { return d.nyt.length }))]);
  colorScale.domain([0, data.length])

  // append the x axis class
  focus.append('g')
       .attr('class', 'axis axis--x')
       .attr('transform', 'translate(0,' + (height - xAxisSpace) +')')

  bindXScale(graphType);
  drawPoints(flattenedData);
  drawDataPoints(graphType);

});

function drawDataPoints(type) {
  if (type == 'author') {
    drawAuthorPoints(flattenedData);
  } else {
    drawDatePoints(flattenedData);
  }
}

function drawDatePoints(data) {
  focus.selectAll('.data-point')
       .data(data)
       .transition()
      //  .delay(function(d, i) {
      //    return i * 50;
      //  })
       .duration(1000)
       .attr('cx', function(d) { return xScale(parseTime(d.publication_dt)); })
}

function drawAuthorPoints(data) {
  focus.selectAll('.data-point')
       .data(data)
       .transition()
      //  .delay(function(d, i) {
      //    return i * .5;
      //  })
       .duration(1000)
       .attr('cx', function(d) { return (xScale(d['book_author']) + xScale.bandwidth()/2); })
       .attr('cy', function(d) {
         // offset for indexing by zero-- none of these are 'zero' reviews
         return yScale(d['review_num'] + 1);
       })
}

function drawPoints(data) {
  var articles = focus.append('g')
                      .attr('class', 'articles');

  focus.selectAll('circle')
          .data(data, function(d) { return d; })
          .enter()
          .append('a')
          .attr('xlink:target', '_blank')
          .attr('xlink:href', function(d) { return d.url; })
          .append('circle')
          .attr('class', 'data-point')
          .attr('fill', function(d) {
            return d3.interpolateSpectral(colorScale(d['author_num']));
          })
          .attr('r', circleRadius)
          .on('mouseover', handleMouseOver)
          .on('mouseout', handleMouseOut);
}

function handleMouseOver(d, i) {
  var textHeight = 15;
  d3.select(this).attr('r', circleRadius * 1.5);
  var x = d3.select(this).attr('cx');
  var y = d3.select(this).attr('cy');

  var group = focus.append('g')
                   .attr('id', 'hover-box');

  var text;
  if (graphType == 'author') {
    text = "Review by: " + d.byline;
  } else {
    text = "Author: " + d.book_author.toUpperCase();
  }

  group.append('text')
       .attr('x', x)
       .attr('y', y - circleRadius*1.5 - textHeight)
       .attr('text-anchor','middle')
       .attr('class', 'book-title')
       .text(d.book_title);

  group.append('text')
       .attr('x', x)
       .attr('y', y - circleRadius*1.5)
       .attr('text-anchor','middle')
       .attr('font-size', '10px')
       .text(text);

  // get the bbox so we can place a background that makes text easier to see
  var bbox = group.node().getBBox();
  var bboxPadding = 5;

  // place the background
  var rect = group.insert('rect', ':first-child')
                  .attr('x', bbox.x - bboxPadding/2)
                  .attr('y', bbox.y - bboxPadding/2)
                  .attr('width', bbox.width + bboxPadding)
                  .attr('height', bbox.height + bboxPadding)
                  .attr('rx', 10)
                  .attr('ry', 10)
                  .attr('class', 'label-background');
}

function handleMouseOut(d) {
  d3.select(this).attr('r', circleRadius);
  d3.select('#hover-box').remove();
}

function flattenData(data) {
  var flattenedArray = [];
  data.forEach(function(datum, authorNum) {
    datum.nyt.forEach(function(d, reviewNum) {
      d['author_num'] = authorNum;
      d['review_num'] = reviewNum;
      flattenedArray.push(d);
    });
  });
  return flattenedArray;
}

function updateXAxis(type) {

  focus.select('.axis--x').call(d3.axisBottom(xScale))

  focus.selectAll('.axis--x')
       .selectAll('text')
       .style('text-anchor', 'end')
       .attr('dx', '-.8em')
       .attr('dy', '.15em')
       .attr('transform', 'rotate(-65)');
}

function nytAPICall(name, api_key) {
  var url = 'https://api.nytimes.com/svc/books/v3/reviews.json';
  url += '?' + $.param({
    'api-key': api_key,
    'author': name
  });
  $.ajax({
    url: url,
    method: 'GET',
  }).done(function(result) {
    return result;
  }).fail(function(err) {
    throw err;
  });
}


</script>
</body>
