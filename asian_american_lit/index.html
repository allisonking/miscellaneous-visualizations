<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
  <script src="d3-tip.js"></script>
  <script src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous"></script>
  <link rel="stylesheet" href="d3-tip.css">

</head>
<style>

.label-background {
  fill: white;
  fill-opacity: .5;
}

.axis {
  font-family: Helvetica, sans-serif;
  font-size: 14px;
}

.book-title {
  font-weight: bold;
}

body {
  font-family: Helvetica;
}

</style>

<body>
<h3>Asian American Literature</h3>
<form >
  <input type='radio' name='reviews' value='author' checked> By Author <br>
  <input type='radio' name='reviews' value='date'> By Date <br><br>
</form>
<svg width="1000" height="500" id="container"></svg>
<script>

var svg = d3.select('#container'),
    w = +svg.attr("width"),
    h = +svg.attr("height");

var margin = {top: 15, right: 200, bottom: 100, left: 100};
var xAxisSpace = 60,
    xAxisPadding = 20,
    circleRadius = 12,
    width = w - margin.right,
    height = h - margin.bottom;

var focus = svg.append('g')
               .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

// set the ranges for the scales
var xScale = d3.scaleBand().rangeRound([0, width]).padding(0.1),
    yScale = d3.scaleLinear().range([height - xAxisSpace - xAxisPadding, 0]);

// listen for radio button change
d3.selectAll("input[name=reviews]").on("change", reviewsSortChanged)

var parseTime = d3.timeParse("%Y-%m-%d")

function reviewsSortChanged() {
  xScale = d3.scaleTime().range([0,width]);
  xScale.domain(findPublicationExtent(all_data));

  console.log(xScale.domain());
}

function findPublicationExtent(data) {
  var dates = [];
  data.forEach(function(datum) {
    var miniExtent = d3.extent(datum.nyt, function(d) { return parseTime(d.publication_dt)});
    dates = dates.concat(miniExtent);
  })
  return d3.extent(dates, function(d) { return d; });
}

var all_data;
d3.json('author_data.json', function(data) {
  all_data = data;
  // set the domains
  xScale.domain(data.map(function(d) { return d.name; }));
  yScale.domain([0, d3.max(data.map(function(d) { return d.nyt.length }))]);

  drawXAxis();
  drawArticlePoints(data);

});

function drawArticlePoints(data) {
  var authorCount = 0;
  var lastAuthor = data[0].name;
  var articles = focus.append('g')
                      .attr('class', 'articles');

  var authorColumn = articles.selectAll('.author-column')
                             .data(data)
                             .enter().append('g')
                             .attr('class', 'author-column')
                             .attr('transform', function(d) {
                               return 'translate(' + (xScale(d.name) + xScale.bandwidth()/2) + ',0)';
                             });

  authorColumn.selectAll('circle')
          .data(function(d) { return d.nyt; })
          .enter()
          .append('a')
          .attr('xlink:target', '_blank')
          .attr('xlink:href', function(d) { return d.url})
          .append('circle')
          .attr('cy', function(d, i) { return yScale(i); })
          .attr('r', circleRadius)
          .attr('fill', function(d, i) {
            if (d['book_author'] != lastAuthor) {
              authorCount += 1;
              lastAuthor = d['book_author'];
            }
            return d3.interpolateSpectral(authorCount/data.length);
          })
          .on('mouseover', handleMouseOver)
          .on('mouseout', handleMouseOut);
}

function handleMouseOver(d, i) {
  var textHeight = 15;
  d3.select(this).attr('r', circleRadius * 1.5);

  var group = focus.append('g')
                   .attr('id', 'hover-box');

  var x = xScale(d.book_author) + xScale.bandwidth()/2;
  var y = yScale(i);

  group.append('text')
       .attr('x', x)
       .attr('y', y - circleRadius*1.5 - textHeight)
       .attr('text-anchor','middle')
       .attr('class', 'book-title')
       .text(d.book_title);

  group.append('text')
       .attr('x', x)
       .attr('y', y - circleRadius*1.5)
       .attr('text-anchor','middle')
       .attr('font-size', '10px')
       .text(d.byline);

  // get the bbox so we can place a background that makes text easier to see
  var bbox = group.node().getBBox();
  var bboxPadding = 5;

  // place the background
  var rect = group.insert('rect', ':first-child')
                  .attr('x', bbox.x - bboxPadding/2)
                  .attr('y', bbox.y - bboxPadding/2)
                  .attr('width', bbox.width + bboxPadding)
                  .attr('height', bbox.height + bboxPadding)
                  .attr('rx', 10)
                  .attr('ry', 10)
                  .attr('class', 'label-background');
}

function handleMouseOut(d) {
  d3.select(this).attr('r', circleRadius);
  d3.select('#hover-box').remove();
}

function drawXAxis() {
  focus.append('g')
       .attr('class', 'axis axis--x')
       .attr('transform', 'translate(0,' + (height - xAxisSpace) +')')

  focus.select('.axis--x').call(d3.axisBottom(xScale))

  focus.selectAll('.axis--x')
       .selectAll('text')
       .style('text-anchor', 'end')
       .attr('dx', '-.8em')
       .attr('dy', '.15em')
       .attr('transform', 'rotate(-65)');
}

function updateXAxis(type) {
  if (type == 'date') {

  } else {

  }
}

function nytAPICall(name, api_key) {
  var url = 'https://api.nytimes.com/svc/books/v3/reviews.json';
  url += '?' + $.param({
    'api-key': api_key,
    'author': name
  });
  $.ajax({
    url: url,
    method: 'GET',
  }).done(function(result) {
    return result;
  }).fail(function(err) {
    throw err;
  });
}


</script>
</body>
